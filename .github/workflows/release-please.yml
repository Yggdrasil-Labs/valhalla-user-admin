name: Release Please

on:
  push:
    branches: [main]
  pull_request:
    types: [opened, synchronize, closed]
    branches: [main]
  workflow_dispatch: {}

permissions:
  contents: write
  pull-requests: write

jobs:
  release-please:
    runs-on: ubuntu-latest
    # é¿å…åŒä¸€äº‹ä»¶æºå¹¶å‘å †ç§¯ï¼ˆæˆªå›¾é‡Œå¤§é‡ in progress çš„æ ¹å› ä¹‹ä¸€ï¼‰
    concurrency:
      group: release-please-${{ github.event_name }}-${{ github.event.pull_request.number || github.ref }}
      cancel-in-progress: true
    # é¿å…é‡å¤æ‰§è¡Œï¼š
    # - å½“ PR åˆå¹¶æ—¶ï¼Œä¼šåŒæ—¶è§¦å‘ push å’Œ pull_request äº‹ä»¶
    # - æˆ‘ä»¬åªåœ¨ push äº‹ä»¶æ—¶æ‰§è¡Œï¼Œå¿½ç•¥ pull_request closed äº‹ä»¶ï¼ˆå› ä¸ºä¼šè§¦å‘ pushï¼‰
    # - ä½†ä¿ç•™ pull_request opened/synchronize äº‹ä»¶ï¼ˆç”¨äºæ›´æ–° release PRï¼‰
    if: |
      github.event_name == 'push' ||
      github.event_name == 'workflow_dispatch' ||
      (
        github.event_name == 'pull_request' &&
        github.event.sender.type != 'Bot' &&
        !startsWith(github.event.pull_request.head.ref, 'release-please--branches--main') &&
        github.event.action != 'closed'
      ) ||
      (
        github.event_name == 'pull_request' &&
        github.event.sender.type != 'Bot' &&
        !startsWith(github.event.pull_request.head.ref, 'release-please--branches--main') &&
        github.event.action == 'closed' &&
        github.event.pull_request.merged == false
      )
    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
      version: ${{ steps.release.outputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0  # è·å–å®Œæ•´çš„ Git å†å²ï¼ŒåŒ…æ‹¬æ‰€æœ‰æ ‡ç­¾

      - name: Generate GitHub App Token
        id: app-token
        # å¦‚æœé…ç½®äº† GitHub Appï¼Œç”Ÿæˆ installation tokenï¼›å¦åˆ™è·³è¿‡
        # ä½¿ç”¨ continue-on-error é¿å… secret ä¸å­˜åœ¨æ—¶å·¥ä½œæµå¤±è´¥
        continue-on-error: true
        uses: tibdex/github-app-token@3beb63f4bd073e61482598c45c71c1019b59b73a # v2.1.0
        with:
          app_id: ${{ secrets.RELEASE_APP_ID }}
          private_key: ${{ secrets.RELEASE_APP_PRIVATE_KEY }}

      - uses: googleapis/release-please-action@16a9c90856f42705d54a6fda1823352bdc62cf38 # v4.4.0
        id: release
        with:
          config-file: .github/release-please-config.json
          manifest-file: .github/.release-please-manifest.json
          # ä¼˜å…ˆä½¿ç”¨ GitHub App tokenï¼Œå…¶æ¬¡ PATï¼Œæœ€åä½¿ç”¨ GITHUB_TOKEN
          # GitHub App token å¯ä»¥é¿å…ä»“åº“æƒé™é™åˆ¶ï¼Œä¸”æ›´å®‰å…¨
          token: ${{ steps.app-token.outputs.token || secrets.RELEASE_TOKEN || secrets.GITHUB_TOKEN }}
          # ç¦ç”¨è‡ªåŠ¨æ·»åŠ æ ‡ç­¾ï¼Œç”±åç»­æ­¥éª¤æ‰‹åŠ¨æ·»åŠ è‡ªå®šä¹‰æ ‡ç­¾
          skip-labeling: true
          # ç¦ç”¨è‡ªåŠ¨åˆ›å»º GitHub Release/Tagï¼Œäº¤ç”± create-tag.yml å’Œ release.yml å¤„ç†
          # è¿™æ ·å¯ä»¥ä½¿ç”¨ PAT (RELEASE_TOKEN) åˆ›å»º Tagï¼Œä»è€Œè‡ªåŠ¨è§¦å‘ Release æ„å»ºå·¥ä½œæµ
          skip-github-release: true

      - name: Add ğŸš€ release label to PR
        env:
          # ä¼˜å…ˆä½¿ç”¨ GitHub App tokenï¼Œå…¶æ¬¡ PATï¼Œæœ€åä½¿ç”¨ GITHUB_TOKEN
          GH_TOKEN: ${{ steps.app-token.outputs.token || secrets.RELEASE_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          echo "Waiting for PR to be searchable..."
          # ç®€å•çš„é‡è¯•é€»è¾‘ï¼šå°è¯• 5 æ¬¡ï¼Œæ¯æ¬¡é—´éš” 5 ç§’
          for i in {1..5}; do
            # æ˜¾å¼æŒ‡å®š repo ä»¥é¿å…éœ€è¦ checkout
            PR_NUMBER=$(gh pr list --repo ${{ github.repository }} --search "head:release-please--branches--main is:open" --json number --jq '.[0].number')

            if [ -n "$PR_NUMBER" ] && [ "$PR_NUMBER" != "null" ]; then
              echo "Found Release PR: #$PR_NUMBER"
              gh pr edit "$PR_NUMBER" --repo ${{ github.repository }} --add-label "ğŸš€ release"
              echo "Added 'ğŸš€ release' label to PR #$PR_NUMBER"
              exit 0
            fi

            echo "Attempt $i: No open release PR found yet. Retrying in 5s..."
            sleep 5
          done

          echo "No open release PR found after retries."
          # ä¸æŠ¥é”™é€€å‡ºï¼Œé¿å…æ ‡è®° workflow ä¸ºå¤±è´¥
          exit 0

  # æ³¨æ„ï¼šå®é™…çš„æ„å»ºå’Œ GitHub Release åˆ›å»ºç”± release.yml åœ¨ tag æ¨é€æ—¶è§¦å‘
  # Tag ç”± create-tag.yml åœ¨ Release PR åˆå¹¶ååˆ›å»º
  log-release:
    needs: release-please
    if: ${{ needs.release-please.outputs.release_created }}
    runs-on: ubuntu-latest
    steps:
      - name: Log release info
        run: |
          echo "ğŸ·ï¸ Release Please updated manifest"
          echo "ğŸ“¦ Version: ${{ needs.release-please.outputs.version }}"
          echo "ğŸ”„ The create-tag.yml workflow will create the tag"
          echo "ğŸ”„ Then release.yml will be triggered by the tag push"
